<html xmlns:th="http://www.thymeleaf.org"
   xmlns:sec="http://www.thymeleaf.org/thymeleaf-extras-springsecurity5">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<title>ğŸ¥•ë‹¹ê·¼ë‚˜ë¼ ë²ˆê°œê³µì£¼</title>
<style>
#navbarDropdown {
   cursor: pointer;
}

#thunderBtn {
   margin: 0;
}
/* Chrome, Safari, Edge, Opera */
input#bid::-webkit-outer-spin-button, input#bid::-webkit-inner-spin-button
   {
   -webkit-appearance: none;
   margin: 0;
}

/* Firefox  */
input#bid[type='number'] {
   -moz-appearance: textfield;
}

.inputbox {
   width: 100%;
   border: 4px #eee solid;
   border-radius: 20px;
   margin: 10px;
   padding: 5px;
   transition: 0.2s;
}

.inputbox:hover {
   transform: scale(1.05);
   transition: 0.3s;
}

.btn-custom {
   background-color: transparent;
   width: 50px;
   height: 45px;
   border: 1px #eee solid;
   border-radius: 20px;
   margin: 0;
   transition: 0.2s;
}

.btn-custom:hover {
   transform: scale(1.05);
   transition: 0.2s;
   box-shadow: 0 0 8px 1px #eee;
}

.btn-report {
   background-color: transparent;
   border: none;
   transition: 0.2s;
}

.btn-report:hover {
   text-shadow: 0 0 2px grey;
   transition: 0.2s;
}

.btn-wish {
   width: 80px;
}

.btn-img {
   width: 20px;
   height: 20px;
}
</style>
</head>
<script
   src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.4.0/Chart.min.js"></script>
<body th:align="center">
   <div class="d-flex" id="wrapper">
      <div id="page-content-wrapper">
         <th:block th:replace="~{fragment/header :: header}"></th:block>
         <!-- Page content-->
         <div class="container-fluid">
            <!------------ ì—¬ê¸°ë¶€í„° ë©”ì¸ ë°”ë””! ì—¬ê¸°ë¶€í„° ì‘ì„±í•˜ë©´ ë¨ ---------------->
            <section class="" style="width: 1200px;">
               <div class="container px-4 px-lg-5 my-5">
                  <div class="row gx-4 gx-lg-5 align-items-center">
                     <div class="" style="display: flex; margin-bottom: 20px;"
                        th:switch="${product.pCategory.toString()}">
                        <div>
                           <span
                              th:text="${product.auction.toString() == 'N'} ? '&nbsp;ì¼ë°˜ ' : '&nbsp;ê²½ë§¤ '"
                              style="font-weight: bold; border-left: 4px solid #eee"></span>
                           <span th:case="DIGI">ë””ì§€í„¸/ê°€ì „</span> <span th:case="FURN">ê°€êµ¬</span>
                           <span th:case="CLOT">ì˜ë¥˜/ì¡í™”</span> <span th:case="BEAU">ë·°í‹°</span>
                           <span th:case="ETC">ê¸°íƒ€</span>
                        </div>
                        <button class="btn-report"
                           style="margin-left: auto; margin-botton: auto;"
                           onclick="report()">
                           <small th:if="${currentUser.id != product.salesId.id}"
                              style="line-height: 35px;">ğŸš¨ ì‹ ê³ </small>
                        </button>
                     </div>
                     <div class="col-md-6" th:align="center">
                        <img class="card-img-top mb-5 mb-md-0"
                           style="max-height: 400px; max-width: 400px; object-fit: contain;"
                           th:src="${product.upload}"
                           onerror="this.src='/images/carrot.png'" alt="...">
                     </div>
                     <div class="col-md-6">
                        <div style="display: flex;">
                           <span id="clock" th:if="${product.auction.toString() == 'Y'}"
                              style="color: red; font-weight: bold; margin-right: auto;"></span>
                        </div>
                        <h2 class="display-8 fw-bolder" style="margin-bottom: 0.8em"
                           th:text="${product.title}"></h2>

                        <div style="display: flex; margin-bottom: 20px;">
                           <table th:cellpadding="0" style="flex-grow: 1;">
                              <tr>
                                 <td rowspan="2" style="width: 60px;"><img
                                    src="/images/prcs-profile.png" alt="..."
                                    style="width: 50px;"></td>
                                 <td style="vertical-align: bottom"><a
                                    id="navbarDropdown" role="button" data-bs-toggle="dropdown"
                                    aria-haspopup="true" aria-expanded="false"
                                    style="font-size: 18px; margin-top: 10px;"> <span
                                       th:text="${product.salesId.nickName}"></span>
                                 </a>
                                    <div class="dropdown-menu dropdown-menu-end"
                                       aria-labelledby="navbarDropdown">
                                       <div class="dropdown-item">
                                          <a class="dropdown-item"
                                             th:href="@{/mypage/myPageMain(id=${product.salesId.id})}">í˜ì´ì§€
                                             ë°©ë¬¸</a>
                                       </div>
                                    </div></td>
                              </tr>
                              <tr>
                                 <td>&nbsp;<label
                                    style="font-size: 15px; margin-bottom: 10px; color: #aaa;"
                                    class="small" th:text="${product.salesId.location}"></label></td>
                              </tr>
                           </table>
                           <div style="flex-grow: 1; height: 80px;">
                              <div th:if="${product.auction.toString() == 'Y'}"
                                 th:align="right">
                                 <div class="small" style="color: #aaa;">
                                    ì‹œì‘ê°€ <span
                                       style="color: #aaa; text-decoration: line-through;"
                                       th:text="${#numbers.formatInteger(product.price, 3, 'COMMA') + 'ì› '}"></span>
                                 </div>
                                 í˜„ì¬ê°€ <span id="price" style="font-weight: bold;"
                                    th:align="center"
                                    th:text="${#numbers.formatInteger(auction.auctionPrice, 3, 'COMMA') + 'ì›'}"></span>
                              </div>
                              <div th:align="right" style="margin-bottom: 5px;"
                                 th:if="${product.auction.toString() == 'N'}">
                                 <span id="price" style="font-weight: bold;" th:align="right"
                                    th:text="${#numbers.formatInteger(product.price, 3, 'COMMA') + 'ì›'}"></span>
                              </div>
                              <div th:if="${product.sold.toString() == 'N'}">
                                 <div style="display: flex; justify-content: right; gap: 8px;"
                                    th:if="${product.salesId.id != currentUser.id}"
                                    th:align="right">
                                    <button th:align="center" class="btn-custom btn-wish"
                                       type="button" onclick="wish()">
                                       <img id="like" class="btn-img"
                                          th:if="${currentUser.id != product.salesId.id}" alt="..."
                                          th:src="${isWished == false ? '/images/empty_heart.png' : '/images/full_heart.png'}">
                                       <span th:text="${wishCnt}"></span>
                                    </button>
                                    <a th:align="center" class="btn-custom" id="navbarDropdown" href="#"
                                       role="button" data-bs-toggle="dropdown"
                                       aria-haspopup="true" aria-expanded="false"
                                       th:if="${product.auction.toString() == 'Y'}" type="button"
                                       onclick="isCurrBid();">
                                       <img class="btn-img" style="margin: 12.5px 0 12.5px 0;" alt="..."
                                       src="/images/bid.png">
                                    </a>
                                    <div id="dropdown" class="dropdown-menu dropdown-menu-end"
                                       aria-labelledby="navbarDropdown"
                                       style="-bs-dropdown-link-active-bg: none;">
                                       <div class="dropdown-item">
                                          <form id="bidForm" th:action="@{/product/bidProduct}"
                                             method="post">
                                             <input th:value="${product.pNo}" name="pNo" type="hidden">
                                             <input th:value="${currentUser.id}" name="id"
                                                type="hidden"> <input id="bid" name="bid"
                                                style="width: 100px; vertical-align: middle;"
                                                type="number" min="${auction.auctionPrice}">&nbsp;<a
                                                class="btn btn-outline-dark flex-shrink-0" type="button"
                                                onclick="bid();">ì…ì°°í•˜ê¸°</a> <input type="text"
                                                style="display: none"> <br> <small>ì…ì°°ì€
                                                ìµœëŒ€ 3ë²ˆê¹Œì§€ ê°€ëŠ¥í•©ë‹ˆë‹¤.</small>
                                          </form>
                                       </div>
                                    </div>
                                    <button class="btn-custom"
                                       th:if="${product.auction.toString() == 'N'}" type="button"
                                       onclick="buyBtn()">
                                       <img class="btn-img" alt="..." src="/images/cart.png">
                                    </button>
                                 </div>
                              </div>
                              <form id="buyForm" th:action="@{/product/buyProduct}"
                                 method="post">
                                 <input th:value="${product.pNo}" name="pNo" type="hidden">
                                 <input th:value="${currentUser.id}" name="id" type="hidden">
                              </form>
                              <form id="reportForm" th:action="@{/product/reportProduct}"
                                 method="get">
                                 <input type="hidden" name="id" th:value="${currentUser.id}">
                                 <input type="hidden" name="type" value="PRODUCT"> <input
                                    type="hidden" name="postNo" th:value="${product.pNo}">
                                 <input id="reportInput" type="hidden" name="rptCon">
                              </form>
                           </div>
                        </div>
                        <section id="section-chart">
                           <div>
                              <div id="legend-div" class="legend-div"></div>
                              <canvas id="myChart" th:if="${product.auction.toString() == 'Y'}" width="400" height="150" style="margin-bottom: 20px;"></canvas>
                           </div>
                        </section>
                        <pre
                           style="margin-bottom: 50px; max-height: 500px; white-space: pre-line; font-family: 'Gowun Dodum', sans-serif;"
                           class="lead" th:text="${product.content}"></pre>
                        <div id="thunderBtn"
                           th:if="${product.delivery.toString() == 'Y'}" th:align="center"
                           class="inputbox" onclick="thunder()">
                           <b>âš¡ ì²œë‘¥ë§¨ ì´ìš© ìƒí’ˆì…ë‹ˆë‹¤! âš¡</b> <input id="delivery"
                              style="display: none;" type="checkbox" name="delivery"
                              value="1"><br> <small>ë°°ë‹¬ë¹„ 1,500ì›ì´ ì¶”ê°€ì ìœ¼ë¡œ
                              ì°¨ê°ë©ë‹ˆë‹¤.</small>
                        </div>
                     </div>
                  </div>
               </div>
            </section>
            <div th:align="center">
               <a
                  th:attr="style=${currentUser.id == product.salesId.id}? 'display: inline' : 'display: none'"
                  style="display: block;" type="button"
                  class="btn btn-outline-dark flex-shrink-0"
                  th:href="@{/product/updateProduct(pNo=${product.pNo})}">ìˆ˜ì •</a> <a
                  th:attr="style=${currentUser.id == product.salesId.id}? 'display: inline' : 'display: none'"
                  style="display: block;" type="submit"
                  class="btn btn-outline-dark flex-shrink-0" onclick="delConfirm();">ì‚­ì œ</a>
               <a type="button" class="btn btn-outline-dark flex-shrink-0"
                  onclick="backBtn();">ì´ì „</a>
            </div>
            <div style="height: 30px;"></div>
            <!------------ ì—¬ê¸°ê¹Œì§€ ë©”ì¸ ë°”ë””! ì—¬ê¸°ê¹Œì§€ ì‘ì„±í•˜ë©´ ë¨ ---------------->
         </div>
      </div>
   </div>
   <th:block th:replace="~{fragment/footer :: footer}"></th:block>
</body>
<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script th:inline="javascript">

  const auctionList = /*[[${map}]]*/; // auctionListë¥¼ JSON í˜•íƒœë¡œ ë°›ì•„ì˜´
  console.log(auctionList);
  
  const dates = Object.values(auctionList).map(dateString => {
      const date = new Date(dateString);
      const year = date.getFullYear();
      const month = String(date.getMonth() + 1).padStart(2, '0');
      const day = String(date.getDate()).padStart(2, '0');
      return `${year}-${month}-${day}`;
      
   }); // ë¬¸ìì—´ì„ Date ê°ì²´ë¡œ ë³€í™˜

  const values = Object.keys(auctionList).map(Number); // í‚¤ë¥¼ ìˆ«ìë¡œ ë³€í™˜
  
  const ctx = document.getElementById('myChart');
  new Chart(ctx, {
    type: 'line',
    data: {
      labels: dates, // í‚¤ ë°°ì—´ì„ ë ˆì´ë¸”ë¡œ ì„¤ì •
      datasets: [{
        label: 'Auction Prices',
        data: values, // ê°’ ë°°ì—´ì„ ë°ì´í„°ë¡œ ì„¤ì •
        borderWidth: 1
      }]
    },
    options: {
      scales: {
         
        y: {
          beginAtZero: false
        }
      }
    }
  });
</script>


<script th:inline="javascript">
/*=============================================
 * ì´ì „ ë²„íŠ¼
 *=============================================*/
 function backBtn() {
   if ([[${edit}]] == 1) {
      history.back(-2);
   } else {
      history.back();
   }
}
 /*=============================================
  * ì°œ ë²„íŠ¼
  *=============================================*/
  function wish() {
    location.href="/product/updateWish?pNo=[[${product.pNo}]]";
 }
 /*=============================================
  * ì‹ ê³  ë²„íŠ¼
  *=============================================*/
  function report() {
    if([[${isReported}]]) {
       alert('ì´ë¯¸ ì‹ ê³ í•˜ì…¨ë„¤ìš”?');
       return;
    } else{
       if (confirm("ì •ë§ ì‹ ê³ í•˜ì‹¤ ê±´ê°€ìš”?")) {
             let promptResult = prompt("ì‚¬ìœ ê°€ ë­˜ê¹Œìš”?");
             if (promptResult == null) {
                return;
             } else if (promptResult == "") {
                alert("ì‹ ê³  ì‚¬ìœ ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.");
             } else {
                $('#reportInput').val(promptResult);
                  $('#reportForm').submit();
             }
         }
    }
}
/*=============================================
 * ê²Œì‹œë¬¼ ì‚­ì œ
 *=============================================*/
function delConfirm() {
   if (confirm("ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) {
      window.location.href = '/product/deleteProduct?pNo=[[${product.pNo}]]&isAuc=[[${product.auction}]]';
   } else {
      return false;
   }
}

/*=============================================
 * ê²½ë§¤ ì‹œê°„ ê°±ì‹ 
 *=============================================*/
let Target = document.getElementById("clock");

function clock() {
   if ([[${product.auction.toString() == 'Y'}]]) {
      let regdate = new Date([[${#dates.format(product.regdate, 'yyyy-MM-dd HH:mm:ss')}]]).getTime();
      let aucDuration = [[${product.aucDuration}]];
      let aucDuToTime = aucDuration * 1000 * 60 * 60 * 24;
      let currentTime = new Date().getTime();
       
       let time = parseInt(regdate) + parseInt(aucDuToTime) - parseInt(currentTime);
   
       if (time < 0) {
          Target.innerText = `ê²½ë§¤ ì¢…ë£Œ`;
          return
       }
       
       let days = Math.floor(time / (1000 * 60 * 60 * 24));
       let hours = Math.floor((time % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
       let minutes = Math.floor((time % (1000 * 60 * 60)) / (1000 * 60));
       let seconds = Math.floor((time % (1000 * 60)) / 1000);
   
       Target.innerText = `ë‚¨ì€ ì‹œê°„ ${days >= 1 ? days + 'ì¼' : ''} ${hours < 10 ? '0' + hours : hours}:${minutes < 10 ? '0' + minutes : minutes}:${seconds < 10 ? '0' + seconds : seconds}`;

   }
}
clock();
setInterval(clock, 1000); // 1ì´ˆë§ˆë‹¤ ì‹¤í–‰
/*=============================================
 * ë§ˆì§€ë§‰ ì…ì°°ìì¸ì§€ í™•ì¸
 *=============================================*/
function isCurrBid() {
   if ([[${currBid.auctionId != null && currBid.auctionId.id == currentUser.id}]]) {
      alert('ì—°ì†ìœ¼ë¡œ ì…ì°°í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
      $("#dropdown").remove();
   }
}

/*=============================================
 * êµ¬ë§¤ ë²„íŠ¼
 *=============================================*/
function buyBtn() {
   if (confirm("êµ¬ë§¤í•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) {
      let deposit;
      if ($('#delivery').length) { // ë‚´ ì”ì•¡ì´ ê°€ê²©ë³´ë‹¤ í´ê¹Œ?
         deposit = [[${currentUser.deposit - product.price - 1500}]];
      } else {
         deposit = [[${currentUser.deposit - product.price}]];
      }
      if(deposit >= 0) {
         $('#buyForm').submit();
      } else {
         alert('ì¬ë”í˜ì´ ì”ì•¡ì´ ë¶€ì¡±í•©ë‹ˆë‹¤!');
         if (confirm('ì¬ë”í˜ì´ ì¶©ì „ í˜ì´ì§€ë¡œ ì´ë™í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
            window.location.href = '/mypage/myDeposit';
         } else {
            return false;
         }
      }
   } else {
      return false;
   }
}

/*=============================================
 * ì…ì°°í•˜ê¸°
 *=============================================*/
 function bid() {
   if($('#bid').val() <= [[${auction.auctionPrice}]]) {
      alert("ì…ì°°ê°€ëŠ” í˜„ì¬ ê²½ë§¤ê°€ë³´ë‹¤ ë†’ì€ ê°€ê²©ë§Œ ê°€ëŠ¥í•©ë‹ˆë‹¤!");
   } else if ([[${isAuctioned}]]){
      alert("ë”ì´ìƒ ì…ì°°í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤!");
      $('#bid').val('');
   } else {
      if(confirm('ì •ë§ ì…ì°°í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
         let deposit;
         if ($('#delivery').length) { // ì²œë‘¥ë§¨ ì´ìš©ì‹œ deposit ì„¤ì • (ë‚´ ì”ì•¡ + ë‚´ ìµœê·¼ ì…ì°°ê¸ˆ - 1500ì›)
            deposit = [[${currentUser.deposit + bidList[0].auctionPrice - 1500}]];
         } else {
            deposit = [[${currentUser.deposit + bidList[0].auctionPrice}]];
         }
         if($('#bid').val() <= deposit) { // ì…ì°°ê°€ < ì”ì•¡
            $('#bidForm').submit();   
            return false;
         } else { // ì…ì°°ê°€ > ì”ì•¡
            alert('ì¬ë”í˜ì´ ì”ì•¡ì´ ë¶€ì¡±í•©ë‹ˆë‹¤!');
            if (confirm('ì¬ë”í˜ì´ ì¶©ì „ í˜ì´ì§€ë¡œ ì´ë™í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
               $('#bid').val('');
               window.location.href = '/mypage/myDeposit';
            } else {
               $('#bid').val('');
               return false;
            }
         }
      }
   }
}
</script>
</html>
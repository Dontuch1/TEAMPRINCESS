<html xmlns:th="http://www.thymeleaf.org"
xmlns:sec="http://www.thymeleaf.org/thymeleaf-extras-springsecurity5">
<head>
<title>ì²œë‘¥ë§¨ ì°¾ì•„ìš”!</title>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">

<!-- ìŠ¤íƒ€ì¼ -->
 <style>

</style>
    
<link th:href="@{/css/myThunderList.css}" rel="stylesheet">

</head>

<!-- ë°°í„°ë¦¬ 60 ì•„ë˜ì¸ ì²œë‘¥ë§¨ì´ ë“¤ì–´ì˜¤ë©´ Qualification() ì‹¤í–‰ -->
<th:block th:with="isThunderAndLowBattery=${currentUser.auth.toString().equals('THUNDER')} and ${currentUser.battery < 60}">
    <th:block th:if="${isThunderAndLowBattery}">
		<body th:align="center" onload="Qualification()">
	</th:block></th:block>
<th:block th:with="isThunderAndLowBattery=${currentUser.auth.toString().equals('THUNDER')} and ${currentUser.battery >= 60}">
    <th:block th:if="${isThunderAndLowBattery}">
		<body th:align="center">
	</th:block></th:block>
	<div class="d-flex" id="wrapper">
		<div id="page-content-wrapper">
			<div th:insert="~{fragment/header :: header}"></div>
			<!-- Page content-->
			<div class="container-fluid">
				<!------------ ì—¬ê¸°ë¶€í„° ë©”ì¸ ë°”ë””! ì—¬ê¸°ë¶€í„° ì‘ì„±í•˜ë©´ ë¨ ---------------->    
    			<div id="wrapper">
					<div class="box box2">	
							
							    <h2 style="margin:30px 0px 0px 30px;"> ğŸ“¤ë¬¼í’ˆ ìˆ˜ë°°ì„œ </h2> 		

						<form th:action="@{/thunder/myThunderList}" method="get">
							<div class="input-group mb-3 right w-25">
								<select class="form-select flex-right " aria-label="Default" name="searchCondition">
										  <option value="TITLE">ì œëª©</option>
										  <option value="CONTENT">ë‚´ìš©</option>
											  <option value="NICKNAME">ë‹‰ë„¤ì„</option>
								</select>
							    <input type="text" class="form-control w-25" placeholder="ê²€ìƒ‰ ì…ë ¥ë€" aria-label="Recipient's username" aria-describedby="button-addon2" name="searchKeyword">
							    <button class="btn btn-outline-secondary" type="submit" id="button-addon2" name="ê²€ìƒ‰" value="ê²€ìƒ‰">ê²€ìƒ‰</button>
							</div>
						</form>

					<br>
					<input type="hidden" id="memberId" th:value="${currentUser.id}" />
				<table>
				    <tr>
				        <th class="center">No.</th>
				        <th class="center">title</th>
				        <th class="center">buyer</th>
				        <th class="center">seller</th>
				        <th class="center">region</th>
				        <th class="center">price</th>
				        <th class="center">date</th>
				        <th class="center">thunder</th>
				    </tr>											
				    <tr th:each="thunder, state : ${thunderList1}">
				    	<th:block th:if="${thunder.thunderId} == null">
					        <td class="center" th:text="${state.count}"></td>
					        <td class="center"><a style="text-decoration: none; color: #333;" th:text="${thunder.pNo.title}" th:href="@{/product/getProduct(pNo=${thunder.pNo.pNo})}"></a></td>
					        <td class="center"><a style="text-decoration: none; color: #333;" th:text="${thunder.buyer.id}" th:href="@{/mypage/myPageMain(id=${thunder.buyer.id})}"></a></td>
					        <td class="center"><a style="text-decoration: none; color: #333;" th:text="${thunder.pNo.salesId.id}" th:href="@{/mypage/myPageMain(id=${thunder.buyer.id})}"></a></td>
	 				        <td class="center" th:text="${thunder.buyer.location}"></td>
					        <td class="center" th:text="${thunder.pNo.price}"></td>
					        <td class="center" th:text="${#dates.format(thunder.pNo.regdate, 'yyyy.MM.dd')}"></td> 
					        <th:block th:if="${currentUser.id} == ${thunder.buyer.id} or ${currentUser.id} == ${thunder.pNo.salesId.id}">
					        <td class="center">
					        	<button type="button" class="btn btn-danger"
					        	id="thunderDelivery" th:value="${thunder.pNo.pNo}" disabled>â›”ì  ê¹€</button>
					        </td>
					        </th:block>
					        <th:block th:if="${currentUser.id} != ${thunder.buyer.id} and ${currentUser.id} != ${thunder.pNo.salesId.id}">
					        <td class="center">
					        	<button type="button" class="btn btn-outline-warning link-dark"
					        	id="thunderDelivery" th:value="${thunder.pNo.pNo}" onclick='thunderDelivery(this)'>ë‹¤ë…€ì˜¤ê¸°1</button>
					        </td>
					        </th:block>
				        </th:block>
				        <th:block th:if="${thunder.thunderId} != null"></th:block>
				        
				    </tr>
				</table>
					<hr>
			<div th:align="center">				
				<span th:if="${!thunderList1.isEmpty}" class="center" style="flex-grow:12; font-size:1.1rem">
							[ <th:block th:each="page : ${#numbers.sequence(startPage, endPage)}" > 
								<a th:if="${page != nowPage}" style="text-decoration: none; color: #222;"
									th:href="@{/thunder/myThunderList(id=${currentUser.id}, page=${page - 1})}"
									th:text="${page}"> </a>
			
								<strong th:if="${page == nowPage}" th:text="${page}"
									style="color: red"></strong> 
							</th:block> ]
							</span>
						</div>	
					
			
				</div>	
			</div>

			<!------------ ì—¬ê¸°ê¹Œì§€ ë©”ì¸ ë°”ë””! ì—¬ê¸°ê¹Œì§€ ì‘ì„±í•˜ë©´ ë¨ ---------------->
			</div>
		</div>
	</div>
	<th:block th:replace="~{fragment/footer :: footer}"></th:block>
</body>
<script type="text/javascript">
function Qualification() {
    console.log("hi");
	
	 let replyData = {
		"memberId" : $('#memberId').val()
	 };
	
	$.ajax({
       type: "POST",
       url: "/thunder/myThunderQualification",
       data: JSON.stringify(replyData),
       contentType: "application/json",
       success: function(response) {
       	   alert("ë°°í„°ë¦¬ê°€ ë¶€ì¡±í•˜ì—¬ ì²œë‘¥ë§¨ìê²©ì´ ë°•íƒˆë©ë‹ˆë‹¤.");
       	   location.href='http://localhost:8081/product/getProductList?type=prod';
       },
       error: function(error) {
           alert("ë¬¸ì œê°€ ìƒê²¼ì–´ìš”!");
       }
   });	
}

function thunderDelivery(ele) {
	let thunder = ele.value;
	console.log(thunder);
	
	let thunderData = {
		"thunder" : thunder,
		"id" : $('#memberId').val	()
	};
	
	if (confirm("ì´ê³³ìœ¼ë¡œ ë¬¼ê±´ì„ ì „ì†¡í•˜ëŠ” ê²ƒì´ í™•ì‹¤í•œê°€ìš”?")) {
		console.log("ì „ì†¡");
		$.ajax({
			type: "POST",
			url: "/thunder/thunderDelivery",
			data: JSON.stringify(thunderData),
			contentType: "application/json",
			success: function(response) {
				alert("ì²œë‘¥ë§¨ë‹˜ ì‹ ì†! ì •í™•! ì „ì†¡ ë¶€íƒë“œë ¤ìš”!");
				document.location.reload();
			},
			error: function(error) {
				alert("ì²œë‘¥ë§¨ ë°°ì •ì— ë¬¸ì œê°€ ìƒê²¼ì–´ìš”.");
			}
		});
	} else {
		console.log("ì·¨ì†Œ");
		alert("ì¢€ ë” ë‚˜ì€ ì „ì†¡ì§€ë¥¼ ì°¾ìœ¼ì…¨ë‚˜ìš”?");
		}
	}	
	
</script>

</html>